<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <link rel="icon" href="/holi_event_50.png" />
    <meta property="og:image" content="/holi_event_200.png" />

    <link
      rel="stylesheet"
      type="text/css"
      href="assets/css/bootstrap.min.css"
    />
    <style>
      .stick-menu {
        position: sticky;
        top: 0;
      }
    </style>
  </head>
  <body>
    <% if(locals.user){ %>
    <div class="cp-body">
      <div class="container dashboard">
        <div class="row g-4">
          <div class="col-md-12 mb-5">
            <div class="py-2">
              <div class="d-flex w-100">
                <h2>Hi, <%= user.name %></h2>
                <div class="ml-auto">
                  <a href="/logout" class="btn btn-danger">Logout</a>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="met-unit my-2">
              <h2 id="total_payment">â‚¹ <%= payment %></h2>
              <p>Total Payment Collected</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="met-unit my-2">
              <h2 id="success_users">
                <%= payments.filter((d) => d.status=="completed").length %>
              </h2>
              <p>Total Users Paid</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="met-unit my-2">
              <h2 id="qr_scans">0</h2>
              <p>QR Code Scanned</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="met-unit my-2">
              <h2>0</h2>
              <p>QR Code Scanned</p>
            </div>
          </div>
          <div class="col-12">
            <div class="row justify-content-center">
              <div class="col-lg-4">
                <div class="container mt-4 stick-menu">
                  <div class="card p-4 shadow-lg">
                    <h4 class="mb-3 text-center">Important Links</h4>
                    <div class="list-group">
                      <ul
                        class="nav nav-pills flex-column mb-auto link-clicker"
                      >
                        <li>
                          <a href="#" class="nav-link active" data-id="users">
                            Users
                          </a>
                        </li>
                        <li>
                          <a href="#" class="nav-link" data-id="qr">
                            QR Scanner
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-8">
                <h3 class="text-center py-3 title mt-3">USERS</h3>
                <div class="vjdynamic users">
                  <div class="container content-container">
                    <%if(users){%>
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Mobile Number</th>
                          <th>Age</th>
                          <th>College</th>
                          <th>Gender</th>
                          <th>Package</th>
                          <th>Status</th>
                          <th>Payment</th>
                          <th>Date</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% users.forEach(user => { %>
                        <tr>
                          <td><%= user.name %></td>
                          <td><%= user.mobileNumber %></td>
                          <td><%= user.age %></td>
                          <td><%= user.college %></td>
                          <td><%= user.gender %></td>
                          <td><%= user.packageName %></td>
                          <td>
                            <%= payments.find((d) =>
                            d.userId.equals(user._id))?.status %>
                          </td>
                          <td>
                            <%= payments.find((d) =>
                            ((d.userId.equals(user._id)) ||
                            (d.userId.equals(user.leader))))?.amount %>
                          </td>
                          <td>
                            <%= new
                            Date(user.createdAt).toLocaleDateString('en-US') %>
                          </td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                    <%}else{%> <%}%>
                  </div>
                </div>
                <div class="vjdynamic qr">
                  <div class="container content-container">
                    <button
                      id="scan-btn"
                      class="btn btn-primary"
                      onclick="toggleQRScanner()"
                    >
                      Start Scanning
                    </button>
                    <video id="video" autoplay style="display: none"></video>
                    <canvas id="canvas" hidden></canvas>
                    <p>Scanned QR Code: <span id="output"></span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <style>
      .dashboard {
        padding: 20px;
      }

      .met-unit {
        background: linear-gradient(135deg, #007bff, #6610f2);
        color: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease-in-out;
      }

      .met-unit:hover {
        transform: translateY(-5px);
      }

      .met-unit h2 {
        font-size: 2rem;
        font-weight: bold;
      }

      .met-unit p {
        font-size: 1.2rem;
      }
    </style>
    <%}else{%>
    <div
      class="vh-100 w-100 d-inline-flex align-items-center justify-content-center"
    >
      <h1>ADMIN</h1>
    </div>
    <%}%>

    <script src="/assets/js/jquery-2.1.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
      let scanning = false;
      let stream = null;
      let scanInterval = null;

      async function startQRScanner() {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = stream;
          scanning = true;

          $("video").show();

          scanInterval = setInterval(() => {
            if (!scanning) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const qrCode = jsQR(
              imageData.data,
              imageData.width,
              imageData.height
            );

            if (qrCode) {
              stopQRScanner();
              getQrDetail(qrCode.data);
            }
          }, 500);
        } catch (err) {
          console.error("Error accessing camera:", err);
        }
      }

      function getQrDetail(id) {
        console.log(id);
      }

      function stopQRScanner() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop()); // Stop the camera
        }
        clearInterval(scanInterval);
        scanning = false;
        $("video").hide();
      }

      function toggleQRScanner() {
        const button = document.getElementById("scan-btn");

        if (scanning) {
          stopQRScanner();
          button.innerText = "Start Scanning";
        } else {
          startQRScanner();
          button.innerText = "Stop Scanning";
        }
      }
    </script>

    <script>
      $(document).ready(() => {
        $(".vjdynamic").hide();
        $(".vjdynamic.users").fadeIn();
        $("ul.link-clicker li a").click(function () {
          const tgt = $(this).data("id");
          if (!tgt) return alert("Invalid Link");
          $(".vjdynamic").hide();
          $(`.vjdynamic.${tgt}`).fadeIn();
          $(".title").text(tgt.toUpperCase());
          $(".link-clicker a").removeClass("active");
          $(this).addClass("active");
        });
      });
    </script>
  </body>
</html>
